<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:fire='http://schemas.microsoft.com/wix/FirewallExtension'
     xmlns:util='http://schemas.microsoft.com/wix/UtilExtension'>
  <?define AppCode = "Bunny" ?>
  <?define AppProductCode = "{2fc96c10-c0e0-43aa-8bc9-00c6b9cca391}" ?>
  <?define AppVersionMajor = "0" ?>
  <?define AppVersionMinor = "5" ?>
  <?define AppVersionPatch = "0" ?>
  <?define AppVersionBuild = "1" ?>
  <?define AppVersion = "$(var.AppVersionMajor).$(var.AppVersionMinor).$(var.AppVersionPatch).$(var.AppVersionBuild)" ?>
  <?define AppManufacturer = "Waveface" ?>
  <?define DefaultCulture = "en-US" ?>
  <Product Id="$(var.AppProductCode)" Name="$(var.AppCode)" Language="!(loc.LANGUAGE)" Version="$(var.AppVersion)" Manufacturer="$(var.AppManufacturer)" UpgradeCode="{2e15093a-8bab-4e3b-9b33-043057fea922}">
    <Package Id="*" InstallerVersion="200" Compressed="yes" />
    <Media Id="1" Cabinet="media1.cab" EmbedCab="no" />
    <Property Id="INSTALLLEVEL" Value="100" />
    <Property Id="ALLUSERS" Value="1" />
    <Property Id="TEST" Value="NO" />
    <!-- <Icon Id="icon.ico" SourceFile="..\ProductBuild\sampleIcon.ico" /> -->

    <Directory Id="TARGETDIR" Name="SourceDir" DiskId="1">
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramMenuDir" Name="!(loc.APPNAME)">
          <Component Id="pmd" Guid="{971d558a-99d6-40cc-89ed-f24620bfcf4b}">
            <RegistryValue Root="HKCU" Key="SOFTWARE\$(var.AppCode)\ProgramMenuDir" Type="string" Value="ProgramMenuDir" KeyPath="yes" />
            <RemoveFolder Id="ProgramMenuDirRF" On="uninstall" />

            <Shortcut Id="ProgMenu.Shortcut.MainEntry" Name="!(loc.APPNAME)"
                      WorkingDirectory="INSTALLDIR" Target="[INSTALLLOCATION]InfiniteStorage.exe">
              <ShortcutProperty Key="System.AppUserModel.ID" Value="com.waveface.infiniteStorage.app"></ShortcutProperty>
            </Shortcut>
            
            <Shortcut Id="ProgMenu.Shortcut.Uninstaller" Name="!(loc.SHORTCUT.UNINSTALLER.NAME)"
                      WorkingDirectory="INSTALLDIR" Target="[UninstallDir]Uninstaller.exe" Arguments="!(loc.CULTURE)" />
            
          </Component>
        </Directory>
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <?include Product.Uninstaller.wxi ?>
    <DirectoryRef Id="TARGETDIR">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLLOCATION" Name="$(var.AppCode)">

          <Component Id="EntityFramework.dll" Guid="*">
            <File Id="EntityFramework.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\EntityFramework.dll" />
          </Component>

          <Component Id="InfiniteStorage.exe.config" Guid="*">
            <File Id="InfiniteStorage.exe.config" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\InfiniteStorage.exe.config"/>
            <fire:FirewallException Id="fwrule1" Name="infiniteStorage" IgnoreFailure="yes" Scope="localSubnet" Program="[INSTALLLOCATION]InfiniteStorage.exe"/>
            <fire:FirewallException Id="fwrule2" Name="bonjour.fw.1" Program="$(env.PROGRAMFILES)Bonjour\mDNSResponder.exe" IgnoreFailure="yes" Scope="localSubnet" />
            <fire:FirewallException Id="fwrule3" Name="bonjour.fw.2" Program="$(env.PROGRAMFILES(X86))Bonjour\mDNSResponder.exe" IgnoreFailure="yes" Scope="localSubnet" />
          </Component>

          <Component Id="System.Data.SQLite.dll" Guid="*">
            <File Id="System.Data.SQLite.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\System.Data.SQLite.dll" />
          </Component>

          <Component Id="System.Data.SQLite.Linq.dll" Guid="*">
            <File Id="System.Data.SQLite.Linq.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\System.Data.SQLite.Linq.dll" />
          </Component>
          
          <Component Id="InfiniteStorage.exe" Guid="*">
            <File Id="InfiniteStorage.exe" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\InfiniteStorage.exe" />
          </Component>

          <Component Id="Mono.Zeroconf.dll" Guid="*">
            <File Id="Mono.Zeroconf.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\Mono.Zeroconf.dll" />
          </Component>

          <Component Id="Mono.Zeroconf.Providers.Bonjour.dll" Guid="*">
            <File Id="Mono.Zeroconf.Providers.Bonjour.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\Mono.Zeroconf.Providers.Bonjour.dll" />
          </Component>

          <Component Id="MZClient.exe" Guid="*">
            <File Id="MZClient.exe" KeyPath="yes" Source="$(var.SolutionDir)\Libs\Mono.Zeroconf\MZClient.exe" />
          </Component>

          <Component Id="log4net.dll" Guid="*">
            <File Id="log4net.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\log4net.dll" />
          </Component>

          <Component Id="Newtonsoft.Json.dll" Guid="*">
            <File Id="Newtonsoft.Json.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\Newtonsoft.Json.dll" />
          </Component>

          <Component Id="websocketsharp.dll" Guid="*">
            <File Id="websocketsharp.dll" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\websocket-sharp.dll" />
          </Component>

          <Directory Id="x86_folder" Name="x86">
            <Component Id="SQLite.Interop.dll.x86" Guid="*">
              <File Id="SQLite.Interop.dll.x86" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\x86\SQLite.Interop.dll" />
            </Component>
          </Directory>


          <Directory Id="x64_folder" Name="x64">
            <Component Id="SQLite.Interop.dll.x64" Guid="*">
              <File Id="SQLite.Interop.dll.x64" KeyPath="yes" Source="$(var.SolutionDir)\Bin\$(var.InfiniteStorage.Configuration)\x64\SQLite.Interop.dll" />
            </Component>
          </Directory>
          
        </Directory>
      </Directory>
    </DirectoryRef>

    <Feature Id='MainFeature' Level='1' Display='collapse'>
      <ComponentRef Id='pmd'/>
      <ComponentRef Id='InfiniteStorage.exe' />
      <ComponentRef Id="Mono.Zeroconf.dll" />
      <ComponentRef Id="Mono.Zeroconf.Providers.Bonjour.dll" />
      <ComponentRef Id="MZClient.exe" />
      <ComponentRef Id="log4net.dll" />
      <ComponentRef Id="Newtonsoft.Json.dll" />
      <ComponentRef Id="websocketsharp.dll" />
      
      <ComponentRef Id="EntityFramework.dll" />
      <ComponentRef Id="InfiniteStorage.exe.config" />
      <ComponentRef Id="System.Data.SQLite.dll" />
      <ComponentRef Id="System.Data.SQLite.Linq.dll" />
      <ComponentRef Id="SQLite.Interop.dll.x86" />
      <ComponentRef Id="SQLite.Interop.dll.x64" />

    </Feature>

    <!--
    <Binary Id="SharpSetupCAFile" SourceFile="$(var.SharpSetupToolsDir)\SharpSetup.CustomActions.CA.dll"/>
    <CustomAction Id="SampleCAData" Property="SampleCA" Value="CommandLine=C:\Windows\system32\ping.exe -n 10 127.0.0.1;ApproximateTime=10" Return="check" />
    <CustomAction Id="SampleCA" DllEntry="ExeCustomAction" BinaryKey="SharpSetupCAFile" Return="check" Execute="deferred" />
    <InstallExecuteSequence>
      <Custom Action="SampleCAData" Before="SampleCA"/>
      <Custom Action="SampleCA" Before="InstallFinalize"/>
    </InstallExecuteSequence>
    <UI>
      <ProgressText Action="SampleCA">Sample Custom Action</ProgressText>
    </UI>
    -->
  </Product>
</Wix>